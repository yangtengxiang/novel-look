<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta name="renderer" content="webkit" />
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />
		<meta charset="UTF-8" />
		<title>阅读</title>
		<link rel="stylesheet" href="./style.css" />
		<!-- 数据变化要只更新文本,尽量不创建dom -->
		<script>
			window.addEventListener("DOMContentLoaded", function () {
				const vscode = acquireVsCodeApi();
				// postMessage,setState,getState

				console.log("webView页面加载完成");
				window.addEventListener("message", function (e) {
					let data = e.data.data;
					let type = e.data.type;
					fn[type](data);
				});
				let fn = {
					undefined() {
						console.error("webView端找不到处理程序,无法执行");
					},
					/*设置一些公共设置,如行高,行间隔,字体大小等*/
					setting() {},
					/*显示章节*/
					showChapter(data) {
						console.warn("开始显示章节",data.title);
						render(data.title, data.list);
					},
				};

				const el = {
					title: document.querySelector(".main .header .title"),
					body: document.querySelector(".main .body"),
				};
				/**
				 * @param {String} title
				 * @param {Array<String>} lines
				 */
				function render(title, lines) {
					el.title.innerText = title;
					let list = el.body.children;
					el.body.style.display = "none";
					if (list.length < lines.length) {
						addLine(lines.length - list.length);
					}
					var i = 0;
					//FIXME:后期考虑优化性能
					// 比如不能再设置时获取属性,否则必须刷新(回流)
					// 循环添加数据
					for (; i < list.length; i++) {
						if (i < lines.length) {
							list[i].innerText = lines[i];
							list[i].style.display = "block";
						} else {
							list[i].style.display = "none";
						}
					}

					el.body.style.display = "block";
				}
				/**
				 * 在行不够用的情况下添加行
				 */
				function addLine(num) {
					// 因为前期肯定隐藏过了dom,这里不在隐藏
					for (var i = 0; i < num; i++) {
						el.body.appendChild(document.createElement("div"));
					}
				}

				// 发送消息
				function postMsg(type, data) {
					vscode.postMessage({ type, data });
				}
			});
		</script>
	</head>
	<body>
		<div class="main">
			<div class="header">
				<div class="title">章节标题</div>
			</div>
			<div class="body">
				<div class="line"> 您现在应该看到内容,如果没有,请重新打开章节 </div>
			</div>
			<div class="footer"></div>
		</div>
	</body>
</html>
